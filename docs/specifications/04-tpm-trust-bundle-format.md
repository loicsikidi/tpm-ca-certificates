# TPM Trust Bundle Format Specification

## Document History

| Version |    Date    |   Author    |   Description    |
|---------|------------|-------------|------------------|
| alpha   | 2025-11-26 | Lo√Øc Sikidi | Initial version  |

## Overview

The TPM Trust Bundle uses the PEM (Privacy Enhanced Mail) format as defined in [RFC 1421](https://datatracker.ietf.org/doc/html/rfc1421) to store a collection of verified TPM Root Endorsement Certificates with associated metadata.

## Format Choice Rationale

PEM format was selected because it:
1. **Is a standard format** - widely recognized and supported
2. **Is expressive and user-friendly** - human-readable with clear delimiters
3. **Supports metadata** - allows text before and after certificate blocks for filtering, integrity verification, and provenance tracking

## Bundle Structure

A TPM Trust Bundle file contains:
1. A global metadata block (at the beginning)
2. One or more certificate blocks, each with its own metadata

```
##
## Global metadata
##

#
# Certificate 1 metadata
#
-----BEGIN CERTIFICATE-----
...certificate data...
-----END CERTIFICATE-----

#
# Certificate 2 metadata
#
-----BEGIN CERTIFICATE-----
...certificate data...
-----END CERTIFICATE-----
```

## 1. Global Metadata Block

### Format

Global metadata uses a double-hash (`##`) prefix to distinguish it from certificate-level metadata:

```
##
## <FILENAME>
##
## Date: <YYYY-MM-DD>
## Commit: <GIT_COMMIT_HASH>
##
## This file has been auto-generated by tpmtb (TPM Trust Bundle)
## and contains a list of verified TPM Root Endorsement Certificates.
##
```

### Conventions

- Each line starts with `##` followed by a space
- The block begins with an empty line (`##` alone)
- The filename placeholder `<FILENAME>` indicates the bundle output filename (defaults to `tpm-ca-certificates.pem`)
- Two required metadata fields:
  - **Date**: Bundle generation date in `YYYY-MM-DD` format (matches release tag)
  - **Commit**: Full Git commit hash (40 characters) from which the bundle was generated
- A descriptive block explicitly indicating the file was auto-generated:
  ```
  ## This file has been auto-generated by tpmtb (TPM Trust Bundle)
  ## and contains a list of verified TPM Root Endorsement Certificates.
  ```
- The block ends with an empty line before the first certificate block


### Required Metadata Fields

| Key | Format | Description | Example |
|-----|--------|-------------|---------|
| `Date` | `YYYY-MM-DD` | Bundle generation date, corresponds to release tag (see [Release Management](02-release-management.md#1-bundle-release-tags)) | `2024-06-15` |
| `Commit` | 40-character hex string | Full Git commit hash identifying the repository state | `a1b2c3d4e5f67890123456789abcdef012345678` |

### Example

```
##
## tpm-ca-certificates.pem
##
## Date: 2024-06-15
## Commit: a1b2c3d4e5f67890123456789abcdef012345678
##
## This file has been auto-generated by tpmtb (TPM Trust Bundle)
## and contains a list of verified TPM Root Endorsement Certificates.
##
```

### Purpose

Global metadata enables:
- **Provenance tracking**: Users can identify when and from what repository state the bundle was generated
- **Integrity verification**: Tools can verify bundle integrity by comparing against transparency logs (Rekor)
- **Version correlation**: The tag allows users to find the corresponding GitHub release and verify CI/CD generation

## 2. Certificate Metadata Block

### Format

Certificate metadata uses a single-hash (`#`) prefix:

```
# <Key>: <Value>
```

### Conventions

- Each line starts with `#` followed by a space
- The block begins with an empty line (`#` alone)
- No empty lines between metadata entries (except "Owner" header)
- No empty line before the PEM certificate block
- Keys use Title Case with spaces allowed (e.g., "Issued At", "Owner", "Not Valid Before")

### Common Metadata Fields

| Key | Description | Example |
|-----|-------------|---------|
| `Certificate` | Certificate name/identifier | `"NPCTxxx ECC521 Root CA"` |
| `Owner` | Owner of the certificate represented by its `Vendor ID` (see [Vendor ID Registry](https://trustedcomputinggroup.org/resource/vendor-id-registry/)) | `NTC` |
| `Issuer` | Certificate issuer DN | `CN=NPCTxxx ECC521 RootCA,O=Nuvoton Technology Corporation,C=TW` |
| `Serial Number` | Certificate serial number (decimal and hex) | `2 (0x2)` |
| `Subject` | Certificate subject DN | `CN=NPCTxxx ECC521 RootCA,O=Nuvoton Technology Corporation,C=TW` |
| `Not Valid Before` | Certificate validity start date | `Thu Apr 27 16:36:58 2023` |
| `Not Valid After` | Certificate validity end date | `Sun Apr 27 16:36:58 2053` |
| `Fingerprint (SHA-256)` | SHA-256 fingerprint (colon-separated hex) | `08:3E:7B:D1:3E:8F:E0:BB:9B:0C:64:DB:9E:0C:83:56:68:1D:F6:57:14:D2:D5:C4:92:5E:B9:8A:E1:36:9D:40` |
| `Fingerprint (SHA1)` | SHA-1 fingerprint (colon-separated hex) | `7C:7B:3C:8A:46:5E:67:D2:8F:4D:B0:F3:5C:E1:20:C4:BB:4A:AC:CC` |

> [!NOTE]
> The keys are sorted in the expected order

### Example

```
#
# Certificate: NPCTxxx ECC521 Root CA
# Owner: NTC
#
# Issuer: CN=NPCTxxx ECC521 RootCA,O=Nuvoton Technology Corporation,C=TW
# Serial Number: 2 (0x2)
# Subject: CN=NPCTxxx ECC521 RootCA,O=Nuvoton Technology Corporation,C=TW
# Not Valid Before: Thu Apr 27 16:36:58 2023
# Not Valid After : Sun Apr 27 16:36:58 2053
# Fingerprint (SHA-256): 08:3E:7B:D1:3E:8F:E0:BB:9B:0C:64:DB:9E:0C:83:56:68:1D:F6:57:14:D2:D5:C4:92:5E:B9:8A:E1:36:9D:40
# Fingerprint (SHA1): 7C:7B:3C:8A:46:5E:67:D2:8F:4D:B0:F3:5C:E1:20:C4:BB:4A:AC:CC
-----BEGIN CERTIFICATE-----
MIICyDCCAlGgAwIBAgIBAjAKBggqhkjOPQQDBDBWMQswCQYDVQQGEwJUVzEqMCgG
A1UECgwhTnV2b3RvbiBUZWNobm9sb2d5IENvcnBvcmF0aW9uMRswGQYDVQQDDBJO
...
-----END CERTIFICATE-----
```

### Purpose

Certificate metadata provides human-readable context about each opaque PEM-encoded certificate, enabling:
- Quick identification of certificates without parsing
- Filtering based on issuer, subject, validity period, or owner
- Verification using fingerprints

## 3. Bundle Generation

### Predictability

Certificate ordering in the bundle must be:
- **Predictable**: Based on vendor order and certificate order in the configuration file

The `tpmtb config format` command ensures the configuration file is properly sorted.

### Metadata Retrieval

The CLI must be **context-aware** and automatically retrieve Git information:
- Current commit hash
- Current branch name

Users can verify a bundle by:
1. **Local generation**: Clone the repository, checkout the tag, and generate locally
2. **Manual specification**: Download the release and run:
   ```bash
   tpmtb generate --date <YYYY-MM-DD> --commit <HASH>
   ```

> [!NOTE]
> When flags `--date` and `--commit` are provided, they take priority over context-aware Git information retrieval.

## Complete Example

```
##
## tpm-ca-certificates.pem
##
## Date: 2024-06-15
## Commit: a1b2c3d4e5f67890123456789abcdef012345678
##
## This file has been auto-generated by tpmtb (TPM Trust Bundle)
## and contains a list of verified TPM Root Endorsement Certificates.
##

#
# Certificate: NPCTxxx ECC521 Root CA
# Owner: NTC
#
# Issuer: CN=NPCTxxx ECC521 RootCA,O=Nuvoton Technology Corporation,C=TW
# Serial Number: 2 (0x2)
# Subject: CN=NPCTxxx ECC521 RootCA,O=Nuvoton Technology Corporation,C=TW
# Not Valid Before: Thu Apr 27 16:36:58 2023
# Not Valid After : Sun Apr 27 16:36:58 2053
# Fingerprint (SHA-256): 08:3E:7B:D1:3E:8F:E0:BB:9B:0C:64:DB:9E:0C:83:56:68:1D:F6:57:14:D2:D5:C4:92:5E:B9:8A:E1:36:9D:40
# Fingerprint (SHA1): 7C:7B:3C:8A:46:5E:67:D2:8F:4D:B0:F3:5C:E1:20:C4:BB:4A:AC:CC
-----BEGIN CERTIFICATE-----
MIICyDCCAlGgAwIBAgIBAjAKBggqhkjOPQQDBDBWMQswCQYDVQQGEwJUVzEqMCgG
A1UECgwhTnV2b3RvbiBUZWNobm9sb2d5IENvcnBvcmF0aW9uMRswGQYDVQQDDBJO
UENUeHh4IEVDQTI1NiBSb290Q0EwHhcNMjMwNDI3MTYzNjU4WhcNNTMwNDI3MTYz
...
-----END CERTIFICATE-----

#
# Certificate "Infineon OPTIGA(TM) RSA Root CA"
# Owner: IFX
#
# Issuer: CN=Infineon OPTIGA(TM) RSA Root CA,O=Infineon Technologies AG,C=DE
# Serial Number: 1 (0x1)
# Subject: CN=Infineon OPTIGA(TM) RSA Root CA,O=Infineon Technologies AG,C=DE
# Not Valid Before: Mon Oct 22 14:12:45 2012
# Not Valid After : Thu Oct 22 14:12:45 2037
# Fingerprint (SHA-256): F8:8A:7C:79:AA:6B:8E:9D:F1:17:4A:3D:C4:7B:4E:8D:3B:9F:C0:3F:22:F7:9A:3F:B8:39:13:7E:41:D6:29:C2
# Fingerprint (SHA1): 5B:4E:8E:08:8B:6C:24:E4:7A:3F:8A:F0:B1:3D:0C:F6:D1:45:3F:8F
-----BEGIN CERTIFICATE-----
MIIFGjCCAwKgAwIBAgIBATANBgkqhkiG9w0BAQsFADBdMQswCQYDVQQGEwJERTEh
MB8GA1UECgwYSW5maW5lb24gVGVjaG5vbG9naWVzIEFHMSswKQYDVQQDDCJJbmZp
bmVvbiBPUFRJR0EoVE0pIFJTQSBSb290IENBMB4XDTEyMTAyMjE0MTI0NVoXDTM3
...
-----END CERTIFICATE-----
```

## Implementation Notes

1. **Parser Requirements**: Tools parsing this format should:
   - Handle both `##` (global) and `#` (certificate) metadata prefixes
   - Preserve whitespace and formatting in metadata values
   - Support arbitrary metadata keys (extensibility)

2. **Validation**: The `tpmtb config validate` command should verify:
   - Global metadata presence and format
   - Certificate metadata format
   - PEM block validity
   - Metadata consistency with certificate content

3. **Extensibility**: Additional metadata fields can be added without breaking existing parsers, as long as the format conventions are followed.
